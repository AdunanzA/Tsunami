build:
  verbosity: minimal
  
  
image: Visual Studio 2015

platform: x64

configuration: Release

environment:
    REPO_DIR: &REPO_DIR c:\tsunami
    SQUIRREL_DIR: &SQUIRREL_DIR c:\squirrel
    TSU_LIB_URL: https://tsunami.adunanza.net/devs/libraries.7z
    SQUIRREL_URL: https://github.com/Squirrel/Squirrel.Windows/releases/download/1.7.8/Squirrel.Windows-1.7.8.zip

# project directory
clone_folder: *REPO_DIR

install:
  - set QTDIR=C:\Qt\5.8\msvc2015_64
  - set PATH=%PATH%;%QTDIR%\bin

before_build:
  - ps: $V_MAJ=select-string -Path ".\version.pri" -Pattern "VER_MAJOR ="
  - ps: $V_MAJ="$V_MAJ"
  - ps: $V_MAJ=$V_MAJ.split()[-1]
  - ps: $V_MIN=select-string -Path ".\version.pri" -Pattern "VER_MINOR ="
  - ps: $V_MIN="$V_MIN"
  - ps: $V_MIN=$V_MIN.split()[-1]
  - ps: $V_BUG=select-string -Path ".\version.pri" -Pattern "VER_BUGFIX ="
  - ps: $V_BUG="$V_BUG"
  - ps: $V_BUG=$V_BUG.split()[-1]
  - ps: Update-AppveyorBuild -Version "0.$V_MIN.$V_BUG.$env:appveyor_build_number"
  
build_script:
  - appveyor DownloadFile "%TSU_LIB_URL%" -FileName "c:\libraries.7z" && 7z x "c:\libraries.7z" -o"%REPO_DIR%"
  - '"C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64'
  - qmake Tsunami.pro
  - nmake release
  - cp lib_rel/*.* release
  - cd release
  - windeployqt --release Tsunami.exe
  - appveyor DownloadFile "%SQUIRREL_URL%" -FIleName "C:\squirrel.zip" && 7z x "C:\squirrel.zip" -o"%SQUIRREL_DIR%"
  - ps: nuget pack c:\tsunami\Tsunami.nuspec -Version "0.$V_MIN.$V_BUG" -Properties Configuration=Release -BasePath .
  - cd "%SQUIRREL_DIR%"
  - ps: .\Squirrel.com -r c:\tsunami\Releases --no-msi --releasify c:\tsunami\release\Tsunami."0.$V_MIN.$V_BUG".nupkg 
  
artifacts:
  - path: Releases
    name: Tsunami

deploy:
  provider: FTP
  protocol: sftp
  host: tsunami.adunanza.net
  username: appveyorBotPlus
  password:
    secure: fudAgfl/410v1jYsi+GqgyPL7mgTEbmAnCBcX+5vlY0ZMF7dFDTJIdbWoYSRCH9m76+jCzjdarkICZpZFz5VipKuRuSAjfzDHAQO1/EMbHDbilPQVIqgf0vqoTfRNYAU79fbcb4w/Ez6je55SUwC6Q==
  folder: releases
  artifacts: Releases
